<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOISE-B站播放器</title>
    <!-- 省略了其他meta标签 -->

    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }
        .center-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 15px; /* 将字体大小调整为15像素 */
    display: none; /* 默认隐藏 */
}

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .floating-button {
            position: fixed;
            top: 88%;
            right: 6px;
            transform: translateY(-50%);
            width: 25px;
            height: 25px;
            background-color: #1e3241e0;
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .center-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 24px;
            display: none; /* 默认隐藏 */
        }
    </style>
</head>
<body>
    <iframe name="player"></iframe> 

    <button class="floating-button" onclick="playRandomVideo()">⏭</button>

    <div class="center-message" id="centerMessage">目前API抽风中…请等待</div>

    <script>
        // 获取页面参数
        const urlParams = new URLSearchParams(window.location.search);
        const mediaId = urlParams.get('id');
        let timerId;

        function playRandomVideo() {
            if (mediaId) {
                // 清除之前的计时器
                if (timerId) {
                    clearTimeout(timerId);
                }

                // 使用fetch获取API数据
                fetch(`https://api.allorigins.win/raw?url=https://api.bilibili.com/x/v3/fav/resource/ids?media_id=${mediaId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('API请求失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 提取每个数据项中的bvid
                        const bvids = data.data.map(item => item.bvid);

                        if (bvids.length === 0) {
                            // 如果没有视频数据，显示信息
                            document.getElementById('centerMessage').style.display = 'block';
                        } else {
                            // 随机选择一个bvid
                            const randomBvid = bvids[Math.floor(Math.random() * bvids.length)];

                            // 设置iframe的src属性以载入视频，但不自动播放
                            document.querySelector('iframe').src = `https://player.bilibili.com/player.html?bvid=${randomBvid}&autoplay=0`;

                            // 查找选定视频的duration，如果有，延时后切换到下一个视频
                            const selectedApiUrl = `https://api.allorigins.win/raw?url=https://api.bilibili.com/x/web-interface/view?bvid=${randomBvid}`;
                            fetch(selectedApiUrl)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('视频数据请求失败');
                                    }
                                    return response.json();
                                })
                                .then(videoData => {
                                    const duration = videoData.data.duration;
                                    console.log(`Video Duration: ${duration} seconds`);

                                    // 延时后切换到下一个视频
                                    timerId = setTimeout(playRandomVideo, duration * 1000);
                                })
                                .catch(error => {
                                    console.error('Error fetching video data:', error);
                                    document.getElementById('centerMessage').style.display = 'block';
                                });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching API data:', error);
                        document.getElementById('centerMessage').style.display = 'block';
                    });
            } else {
                console.error('Missing "id" parameter in the URL.');
                document.getElementById('centerMessage').style.display = 'block';
            }
        }

        // 开始载入第一个视频
        playRandomVideo();
    </script>
</body>
</html>
